<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>7 Dní</title>
    <link rel="manifest" href="../pwa/manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">
    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        body { -webkit-tap-highlight-color: transparent; }
        
        #back-btn {
            position: fixed; top: 12px; left: 16px;
            z-index: 100;
            width: 44px; height: 44px; border-radius: 50%;
            background: #ffffff; 
            border: 1px solid #e2e8f0;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: #475569; font-size: 1.2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        #back-btn:hover { background: #fffbeb; transform: translateX(-3px); }
        #back-btn:active { transform: scale(0.92) translateX(-3px); }
    </style>
</head>
<body class="bg-white font-sans text-slate-900 overflow-hidden h-screen flex flex-col">

    <a href="../index.html" id="back-btn">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
    </a>

    <!-- Header -->
    <div class="bg-slate-50/80 backdrop-blur-md border-b border-slate-200 p-4 pt-16 z-40">
        <div class="flex gap-2 max-w-md mx-auto">
            <select id="monthSelect" class="flex-1 p-3 rounded-xl bg-white border border-slate-300 font-bold text-slate-700 outline-none shadow-sm">
                <!-- Options populated by JS -->
            </select>
            <select id="yearSelect" class="flex-1 p-3 rounded-xl bg-white border border-slate-300 font-bold text-slate-700 outline-none shadow-sm">
                <!-- Options populated by JS -->
            </select>
        </div>
    </div>

    <!-- Main Content Area -->
    <div id="containerRef" class="relative flex-1 bg-white overflow-hidden">
        
        <!-- Vizuální pravítko -->
        <div id="ruler" class="absolute left-0 right-0 top-1/2 -translate-y-1/2 pointer-events-none z-20 mx-auto max-w-md border-y-2 border-blue-600 bg-blue-50/20">
            <div class="absolute -top-6 left-6 text-[10px] font-black text-blue-600 uppercase tracking-widest">
                Začátek výběru
            </div>
            <div class="absolute -bottom-6 left-6 text-[10px] font-black text-blue-600 uppercase tracking-widest">
                Konec výběru
            </div>
        </div>

        <!-- Scroll Container -->
        <div id="scrollRef" class="h-full w-full overflow-y-scroll snap-y snap-mandatory scrollbar-hide overscroll-none">
            <div id="paddingTop"></div>
            <div id="daysContainer">
                <!-- Days populated by JS -->
            </div>
            <div id="paddingBottom"></div>
        </div>
    </div>

    <!-- Footer Info -->
    <div class="bg-slate-900 text-white p-5 pb-8 z-40 shadow-[0_-10px_30px_rgba(0,0,0,0.2)]">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div class="flex-1">
                <p class="text-[10px] text-slate-400 uppercase font-black mb-1">Vybraný rozsah (7 dní)</p>
                <p id="selectionText" class="text-base font-bold truncate">
                    <!-- Populated by JS -->
                </p>
            </div>
            <button id="todayBtn" class="ml-4 bg-blue-600 active:bg-blue-700 px-6 py-3 rounded-xl text-xs font-black tracking-widest transition-transform active:scale-95">
                DNES
            </button>
        </div>
    </div>

    <script>
        // === CONFIG ===
        const ITEM_HEIGHT = 60;
        const VISIBLE_ITEMS = 7;
        const RULER_HEIGHT = ITEM_HEIGHT * VISIBLE_ITEMS;
        let daysData = [];
        let isScrolling = false;

        // === DOM ELEMENTS ===
        const scrollRef = document.getElementById('scrollRef');
        const containerRef = document.getElementById('containerRef');
        const daysContainer = document.getElementById('daysContainer');
        const paddingTop = document.getElementById('paddingTop');
        const paddingBottom = document.getElementById('paddingBottom');
        const ruler = document.getElementById('ruler');
        const monthSelect = document.getElementById('monthSelect');
        const yearSelect = document.getElementById('yearSelect');
        const selectionText = document.getElementById('selectionText');
        const todayBtn = document.getElementById('todayBtn');

        // === STATE ===
        const today = new Date();
        let viewDate = { year: today.getFullYear(), month: today.getMonth() };
        let activeIndex = 0;

        // === UTILS ===
        const monthsList = ["Leden", "Únor", "Březen", "Duben", "Květen", "Červen", "Červenec", "Srpen", "Září", "Říjen", "Listopad", "Prosinec"];
        const yearsList = Array.from({ length: 101 }, (_, i) => 1970 + i);

        // === INIT DROPDOWNS ===
        monthsList.forEach((m, i) => {
            const opt = document.createElement('option');
            opt.value = i;
            opt.innerText = m;
            monthSelect.appendChild(opt);
        });
        yearsList.forEach(y => {
            const opt = document.createElement('option');
            opt.value = y;
            opt.innerText = y;
            yearSelect.appendChild(opt);
        });

        const updateDropdowns = () => {
            monthSelect.value = viewDate.month;
            yearSelect.value = viewDate.year;
        };

        // === DATA GENERATION ===
        const generateDays = (centerYear) => {
            console.log("Generating days for center year:", centerYear);
            const result = [];
            const startYear = centerYear - 1;
            const endYear = centerYear + 1;

            for (let y = startYear; y <= endYear; y++) {
                for (let m = 0; m < 12; m++) {
                    const date = new Date(y, m, 1);
                    const monthName = monthsList[m];
                    while (date.getMonth() === m) {
                        result.push({
                            id: `${y}-${m}-${date.getDate()}`,
                            dateObj: new Date(date),
                            dayNum: date.getDate(),
                            month: m,
                            year: y,
                            dayName: date.toLocaleString('cs-CZ', { weekday: 'short' }),
                            monthName: monthName
                        });
                        date.setDate(date.getDate() + 1);
                    }
                }
            }
            return result;
        };

        // === RENDERING ===
        const renderDays = (days) => {
            daysContainer.innerHTML = '';
            // Using DocumentFragment for performance
            const fragment = document.createDocumentFragment();
            
            days.forEach((day, index) => {
                const el = document.createElement('div');
                el.className = 'day-item flex items-center justify-center snap-start w-full';
                el.style.height = `${ITEM_HEIGHT}px`;
                el.dataset.index = index;
                el.id = `day-${index}`;
                
                // Content will be updated by updateVisuals to avoid massive initial render cost if possible, 
                // but for ~1000 items simple HTML string is fine.
                // We'll render static content here and changing classes in updateVisuals
                
                const isWeekend = day.dateObj.getDay() === 0 || day.dateObj.getDay() === 6;
                // Initial classes (inactive state)
                
                el.innerHTML = `
                    <div class="day-content flex items-center w-full max-w-xs px-10 transition-all duration-200 text-slate-300 opacity-50">
                        <span class="day-num text-2xl font-mono w-10 text-right">
                            ${day.dayNum}.
                        </span>
                        <div class="flex flex-col ml-6">
                            <span class="day-name text-sm font-bold uppercase tracking-tight ${isWeekend ? 'weekend-text' : ''}">
                                ${day.dayName}
                            </span>
                            ${day.dayNum === 1 ? `<span class="month-label text-[9px] font-black uppercase text-slate-400">${day.monthName} ${day.year}</span>` : ''}
                        </div>
                        <div class="indicator ml-auto flex gap-1 hidden">
                            <div class="w-1.5 h-1.5 rounded-full bg-blue-500 animate-pulse"></div>
                        </div>
                    </div>
                `;
                fragment.appendChild(el);
            });
            daysContainer.appendChild(fragment);
        };

        // === VISUAL UPDATES ===
        const updateVisuals = () => {
            // Logic: isSelected = index >= activeIndex && index < activeIndex + VISIBLE_ITEMS
            // We can iterate optimally or just update all if needed. 
            // Better: update only changed items. But simpler: querySelector for active ones.
            
            // First, reset previously active items? 
            // Ideally we want to be performant.
            // Let's loop through the window of "potentially visible" items or just brute force active class toggling
            // Since we know the activeIndex, we know exactly which range is active.
            
            // We need to clear previous styling
            document.querySelectorAll('.day-content.active-day').forEach(el => {
                el.classList.remove('active-day', 'text-blue-700');
                el.classList.add('text-slate-300', 'opacity-50');
                el.querySelector('.day-num').classList.remove('font-black');
                el.querySelector('.indicator').classList.add('hidden');
                
                const monthLabel = el.querySelector('.month-label');
                if(monthLabel) monthLabel.classList.replace('text-slate-900', 'text-slate-400');
                
                // Reset red text for weekends if it was active
                 const dayName = el.querySelector('.day-name');
                 if (dayName.classList.contains('text-red-500')) {
                     dayName.classList.remove('text-red-500');
                 }
            });

            // Set new active classes
            for (let i = activeIndex; i < activeIndex + VISIBLE_ITEMS; i++) {
                const dayEl = document.getElementById(`day-${i}`);
                if (dayEl) {
                    const content = dayEl.querySelector('.day-content');
                    content.classList.remove('text-slate-300', 'opacity-50');
                    content.classList.add('active-day', 'text-blue-700');
                    content.querySelector('.day-num').classList.add('font-black');
                    content.querySelector('.indicator').classList.remove('hidden');
                    
                    const monthLabel = content.querySelector('.month-label');
                    if(monthLabel) monthLabel.classList.replace('text-slate-400', 'text-slate-900');
                    
                    // Specific logic for first item (month label always visible logic not fully ported from React but implied)
                    // React logic: (day.dayNum === 1 || isFirstInSelection)
                    // If it's the first in selection and NOT day 1, we might need to inject the label dynamically?
                    // The React code rendered it conditionally. 
                    // Let's stick to static rendering for simplicity, or we can dynamic add it.
                    // React: {(day.dayNum === 1 || isFirstInSelection) && ...}
                    // My static render only did day.dayNum === 1. 
                    // Let's fix this dynamic label:
                    
                    let labelSpan = content.querySelector('.month-label');
                    if (!labelSpan && i === activeIndex) {
                        // Create it if missing for first item
                        const d = daysData[i];
                        const div = content.querySelector('.flex.flex-col');
                        if (d && div) {
                            labelSpan = document.createElement('span');
                            labelSpan.className = "month-label text-[9px] font-black uppercase text-slate-900 temp-label";
                            labelSpan.innerText = `${d.monthName} ${d.year}`;
                            div.appendChild(labelSpan);
                        }
                    } else if (labelSpan && i === activeIndex) {
                        // Make sure it's styled active
                        labelSpan.classList.replace('text-slate-400', 'text-slate-900');
                    }
                    
                    // Weekend red color logic
                    const d = daysData[i];
                    if (d) {
                         const isWeekend = d.dateObj.getDay() === 0 || d.dateObj.getDay() === 6;
                         if (isWeekend) {
                            content.querySelector('.day-name').classList.add('text-red-500');
                         }
                    }
                }
            }
            
            // Clean up temp labels on non-active first items
            document.querySelectorAll('.temp-label').forEach(el => {
                const parentDay = el.closest('.day-item');
                const index = parseInt(parentDay.dataset.index);
                if (index !== activeIndex) {
                    el.remove();
                }
            });

            // Update footer text
            const startDay = daysData[activeIndex];
            const endDay = daysData[activeIndex + 6];
            if (startDay && endDay) {
                selectionText.innerText = `${startDay.dayNum}. ${monthsList[startDay.month]} – ${endDay.dayNum}. ${monthsList[endDay.month]}`;
            }
        };

        // === SCROLL & SIZING ===
        const updatePaddings = () => {
            const h = containerRef.offsetHeight;
            ruler.style.height = `${RULER_HEIGHT}px`;
            const pad = (h - RULER_HEIGHT) / 2;
            paddingTop.style.height = `${pad}px`;
            paddingBottom.style.height = `${pad + (RULER_HEIGHT - ITEM_HEIGHT)}px`;
        };

        const handleScroll = () => {
            const scrollTop = scrollRef.scrollTop;
            const newIndex = Math.round(scrollTop / ITEM_HEIGHT);
            
            if (newIndex !== activeIndex && daysData[newIndex]) {
                activeIndex = newIndex;
                updateVisuals();
                
                const currentDay = daysData[activeIndex];
                if (!isScrolling) {
                    if (currentDay.month !== viewDate.month || currentDay.year !== viewDate.year) {
                        viewDate = { year: currentDay.year, month: currentDay.month };
                        updateDropdowns();
                    }
                }
            }
        };

        const scrollToDate = (year, month, day = 1, smooth = true) => {
            // If year changed significantly, we might need to regenerate data?
            // Current simple logic: we generated year-1 to year+1 based on viewDate.
            // If jump is far, we regenerate.
            
            // Check if date is within current range
            let targetIndex = daysData.findIndex(d => d.year === year && d.month === month && d.dayNum === day);
            
            if (targetIndex === -1) {
                // Regenerate
                viewDate = { year, month };
                daysData = generateDays(year);
                renderDays(daysData);
                targetIndex = daysData.findIndex(d => d.year === year && d.month === month && d.dayNum === day);
            }

            if (targetIndex !== -1) {
                isScrolling = true;
                scrollRef.scrollTo({
                    top: targetIndex * ITEM_HEIGHT,
                    behavior: smooth ? 'smooth' : 'auto'
                });
                setTimeout(() => { isScrolling = false; }, 800);
            }
        };

        // === EVENT HANDLERS ===
        window.addEventListener('resize', updatePaddings);
        scrollRef.addEventListener('scroll', handleScroll);

        const handleManualChange = (newYear, newMonth) => {
            viewDate = { year: parseInt(newYear), month: parseInt(newMonth) };
            scrollToDate(viewDate.year, viewDate.month);
        };

        monthSelect.addEventListener('change', (e) => handleManualChange(viewDate.year, e.target.value));
        yearSelect.addEventListener('change', (e) => handleManualChange(e.target.value, viewDate.month));
        
        todayBtn.addEventListener('click', () => {
            const now = new Date();
            scrollToDate(now.getFullYear(), now.getMonth(), now.getDate());
        });

        // === STARTUP ===
        updatePaddings();
        daysData = generateDays(viewDate.year);
        renderDays(daysData);
        updateDropdowns(); // Set initial dropdown values

        // Initial scroll to today
        setTimeout(() => {
            const now = new Date();
            const todayIndex = daysData.findIndex(d => 
                d.year === now.getFullYear() && 
                d.month === now.getMonth() && 
                d.dayNum === now.getDate()
            );
            
            if (todayIndex !== -1) {
                scrollRef.scrollTop = todayIndex * ITEM_HEIGHT;
                activeIndex = todayIndex;
                updateVisuals();
            }
        }, 100);

    </script>
</body>
</html>